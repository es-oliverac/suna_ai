# PostgreSQL configuration for Suna/Kortix - Optimized for EasyPanel
# This configuration is tuned for a server with 4GB RAM and good performance

# Memory Settings
shared_buffers = 1GB                    # 25% of total RAM
effective_cache_size = 3GB              # 75% of total RAM
work_mem = 16MB                         # For complex queries
maintenance_work_mem = 256MB            # For maintenance operations
huge_pages = try                        # Try to use huge pages

# Connection Settings
max_connections = 200                   # Maximum concurrent connections
superuser_reserved_connections = 3      # Reserved for superusers

# Write Ahead Log (WAL) Settings
wal_level = replica                     # Enable replication
wal_buffers = 16MB                      # WAL buffer size
min_wal_size = 1GB                      # Minimum WAL size
max_wal_size = 4GB                      # Maximum WAL size
checkpoint_completion_target = 0.9      # Spread checkpoints over time

# Query Planner
random_page_cost = 1.1                  # SSD optimized
effective_io_concurrency = 200          # For SSDs
default_statistics_target = 100         # Statistics target

# Background Writer
bgwriter_delay = 200ms                  # Background writer delay
bgwriter_lru_maxpages = 100            # Background writer max pages
bgwriter_lru_multiplier = 2.0          # Background writer multiplier

# Auto Vacuum
autovacuum = on                         # Enable autovacuum
autovacuum_max_workers = 3              # Auto vacuum workers
autovacuum_naptime = 1min               # Auto vacuum nap time
autovacuum_vacuum_threshold = 50        # Vacuum threshold
autovacuum_vacuum_scale_factor = 0.2    # Vacuum scale factor
autovacuum_analyze_threshold = 50       # Analyze threshold
autovacuum_analyze_scale_factor = 0.1   # Analyze scale factor

# Logging
log_destination = 'stderr'              # Log to stderr
logging_collector = off                 # No logging collector (Docker handles this)
log_min_duration_statement = 1000       # Log slow queries (>1s)
log_checkpoints = on                    # Log checkpoints
log_connections = off                   # Don't log connections (too verbose)
log_disconnections = off                # Don't log disconnections
log_lock_waits = on                     # Log lock waits
log_temp_files = 10MB                   # Log temp files >10MB

# Performance
synchronous_commit = on                 # Ensure data safety
full_page_writes = on                   # Enable full page writes
wal_compression = on                    # Compress WAL
max_wal_senders = 3                     # Max WAL senders
hot_standby = on                        # Hot standby

# Time zone
timezone = 'UTC'                        # Use UTC timezone
log_timezone = 'UTC'                    # Log in UTC

# Locale
lc_messages = 'en_US.utf8'              # Messages locale
lc_monetary = 'en_US.utf8'              # Monetary locale
lc_numeric = 'en_US.utf8'               # Numeric locale
lc_time = 'en_US.utf8'                  # Time locale

# Other optimizations
max_locks_per_transaction = 64          # Locks per transaction
max_pred_locks_per_transaction = 64     # Predicate locks per transaction
deadlock_timeout = 1s                   # Deadlock timeout
statement_timeout = 0                   # No statement timeout (app handles this)
lock_timeout = 0                        # No lock timeout
idle_in_transaction_session_timeout = 60000  # 1 minute idle timeout

# Extensions for Suna/Kortix
shared_preload_libraries = 'pg_stat_statements'  # Load pg_stat_statements